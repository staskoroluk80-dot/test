<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ß–∞—Ç –∑ –ê–≤–∞—Ç–∞—Ä–∞–º–∏</title>
    <style>
        /* === –ë–ê–ó–ê === */
        * { box-sizing: border-box; }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: #2d2d2d; height: 100dvh; width: 100vw; overflow: hidden; display: flex; }

        /* === –ï–ö–†–ê–ù –í–•–û–î–£ === */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #1c1c1c; display: flex; justify-content: center; align-items: center; z-index: 999; }
        .login-box { background: #2c2c2c; padding: 30px; border-radius: 15px; text-align: center; color: white; width: 90%; max-width: 320px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        
        /* –°—Ç–∏–ª—ñ –¥–ª—è –≤–∏–±–æ—Ä—É —Ñ–æ—Ç–æ */
        .avatar-upload { width: 100px; height: 100px; background: #444; border-radius: 50%; margin: 0 auto 20px; position: relative; cursor: pointer; overflow: hidden; border: 2px dashed #666; display: flex; align-items: center; justify-content: center; transition: 0.3s; }
        .avatar-upload:hover { border-color: #0088cc; background: #3a3a3a; }
        .avatar-upload img { width: 100%; height: 100%; object-fit: cover; display: none; }
        .avatar-upload span { font-size: 30px; color: #aaa; }
        #file-input { display: none; }

        .login-box input[type="text"] { padding: 12px; border-radius: 8px; border: 1px solid #444; background: #222; color: white; width: 100%; margin-bottom: 15px; outline: none; text-align: center; }
        .login-box button { padding: 12px; background: #0088cc; color: white; border: none; border-radius: 8px; cursor: pointer; width: 100%; font-weight: bold; }

        /* === –ì–û–õ–û–í–ù–ò–ô –ï–ö–†–ê–ù === */
        #app { display: flex; width: 100%; height: 100%; display: none; }

        /* –°–∞–π–¥–±–∞—Ä */
        #sidebar { width: 320px; background: #212121; border-right: 1px solid #0f0f0f; display: flex; flex-direction: column; flex-shrink: 0; }
        .sidebar-header { padding: 15px; color: white; font-weight: bold; background: #2c2c2c; height: 60px; display: flex; align-items: center; }
        #user-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex-grow: 1; }
        
        #user-list li { padding: 10px 15px; color: #fff; cursor: pointer; border-bottom: 1px solid #2a2a2a; display: flex; align-items: center; transition: 0.2s; }
        #user-list li:hover { background: #2a2a2a; }
        #user-list li.active { background: #2b5278; }

        /* –ê–≤–∞—Ç–∞—Ä–∫–∏ –≤ —Å–ø–∏—Å–∫—É */
        .avatar { width: 50px; height: 50px; border-radius: 50%; margin-right: 15px; background: #555; object-fit: cover; flex-shrink: 0; }
        .default-avatar { width: 50px; height: 50px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 50%; margin-right: 15px; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; flex-shrink: 0; font-size: 20px; }

        .user-info { display: flex; flex-direction: column; overflow: hidden; }
        .user-name { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* –ß–∞—Ç */
        #chat-area { flex-grow: 1; background: #0e1621; display: flex; flex-direction: column; position: relative; min-width: 0; }
        #chat-header { padding: 0 15px; background: #212121; color: white; border-bottom: 1px solid #0f0f0f; font-weight: bold; height: 60px; display: flex; align-items: center; gap: 10px; }
        
        /* –ú—ñ–Ω—ñ-–∞–≤–∞—Ç–∞—Ä –≤ —à–∞–ø—Ü—ñ —á–∞—Ç—É */
        .chat-header-avatar { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; }

        #back-btn { display: none; background: none; border: none; color: white; font-size: 24px; cursor: pointer; }
        
        #messages { flex-grow: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; background-image: url('https://web.telegram.org/img/bg_0.png'); background-size: cover; }
        
        .message { max-width: 80%; padding: 8px 12px; border-radius: 12px; color: white; font-size: 15px; line-height: 1.4; position: relative; word-wrap: break-word; display: flex; flex-direction: column; }
        .message.my { background: #2b5278; align-self: flex-end; border-bottom-right-radius: 0; }
        .message.other { background: #182533; align-self: flex-start; border-bottom-left-radius: 0; }

        #input-area { padding: 10px; background: #212121; display: flex; gap: 10px; align-items: center; flex-shrink: 0; }
        #input-area input { flex-grow: 1; padding: 12px 20px; border-radius: 25px; border: none; background: #0e1621; color: white; font-size: 16px; outline: none; }
        #input-area button { background: #0088cc; color: white; border: none; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; display: flex; justify-content: center; align-items: center; font-size: 20px; flex-shrink: 0; }

        /* –ú–æ–±—ñ–ª—å–Ω–∞ –∞–¥–∞–ø—Ç–∞—Ü—ñ—è */
        @media (max-width: 850px) {
            #sidebar { width: 100%; }
            #chat-area { width: 100%; }
            #app:not(.chat-open) #sidebar { display: flex; }
            #app:not(.chat-open) #chat-area { display: none; }
            #app.chat-open #sidebar { display: none; }
            #app.chat-open #chat-area { display: flex; }
            #back-btn { display: block; }
        }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <label for="file-input" class="avatar-upload" id="avatar-preview-container">
                <span>üì∑</span>
                <img id="avatar-preview" src="" alt="">
            </label>
            <input type="file" id="file-input" accept="image/*">
            
            <p style="color: #bbb; font-size: 13px; margin: 5px 0 15px;">–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –Ω–∞ –∫–∞–º–µ—Ä—É, —â–æ–± –¥–æ–¥–∞—Ç–∏ —Ñ–æ—Ç–æ</p>
            
            <input type="text" id="username-input" placeholder="–í–∞—à–µ —ñ–º'—è..." autocomplete="off">
            <button onclick="login()">–£–≤—ñ–π—Ç–∏</button>
        </div>
    </div>

    <div id="app">
        <div id="sidebar">
            <div class="sidebar-header">–ö–æ–Ω—Ç–∞–∫—Ç–∏</div>
            <ul id="user-list"></ul>
        </div>

        <div id="chat-area">
            <div id="chat-header">
                <button id="back-btn" onclick="closeChat()">‚¨Ö</button>
                <img id="chat-header-img" class="chat-header-avatar" style="display:none;">
                <span id="chat-title">–ß–∞—Ç</span>
            </div>
            
            <div id="messages" style="display: none;"></div>

            <form id="input-area" style="display: none;">
                <input id="msg-input" autocomplete="off" placeholder="–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..." />
                <button type="submit">‚û§</button>
            </form>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
        // !!! –¢–í–û–Ñ –ü–û–°–ò–õ–ê–ù–ù–Ø !!!
        const REPLIT_URL = "https://6a216fcf-12cf-4fac-8b1d-97739aabb946-00-33ambi0sfbjo6.spock.replit.dev";
        
        const socket = io(REPLIT_URL);
        
        let myNickname = "";
        let myAvatar = null; // –¢—É—Ç –±—É–¥–µ Base64 –∫–∞—Ä—Ç–∏–Ω–∫–∞
        let currentChatUser = null;
        let userAvatars = {}; // –ö–µ—à –¥–ª—è –∞–≤–∞—Ç–∞—Ä–æ–∫ —ñ–Ω—à–∏—Ö —é–∑–µ—Ä—ñ–≤ { "Name": "base64" }
        let chats = {};

        // === 1. –û–ë–†–û–ë–ö–ê –§–û–¢–û (–°—Ç–∏—Å–Ω–µ–Ω–Ω—è) ===
        document.getElementById('file-input').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    // –°—Ç–≤–æ—Ä—é—î–º–æ "–≤—ñ—Ä—Ç—É–∞–ª—å–Ω–µ –ø–æ–ª–æ—Ç–Ω–æ" –¥–ª—è –∑–º–µ–Ω—à–µ–Ω–Ω—è –∫–∞—Ä—Ç–∏–Ω–∫–∏
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // –ó–∞–¥–∞—î–º–æ –º–∞–∫—Å —Ä–æ–∑–º—ñ—Ä (100x100 –ø—ñ–∫—Å–µ–ª—ñ–≤ –¥–æ—Å—Ç–∞—Ç–Ω—å–æ –¥–ª—è –∞–≤–∞—Ç–∞—Ä–∫–∏)
                    const maxSize = 150;
                    let width = img.width;
                    let height = img.height;
                    
                    if (width > height) {
                        if (width > maxSize) { height *= maxSize / width; width = maxSize; }
                    } else {
                        if (height > maxSize) { width *= maxSize / height; height = maxSize; }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // –ö–æ–Ω–≤–µ—Ä—Ç—É—î–º–æ –≤ —Ä—è–¥–æ–∫ (Base64) –Ω–∏–∑—å–∫–æ—ó —è–∫–æ—Å—Ç—ñ
                    myAvatar = canvas.toDataURL('image/jpeg', 0.7);
                    
                    // –ü–æ–∫–∞–∑—É—î–º–æ –ø—Ä–µ–≤'—é
                    const preview = document.getElementById('avatar-preview');
                    preview.src = myAvatar;
                    preview.style.display = 'block';
                    document.querySelector('.avatar-upload span').style.display = 'none';
                }
                img.src = event.target.result;
            }
            reader.readAsDataURL(file);
        });

        // === 2. –í–•–Ü–î ===
        function login() {
            const input = document.getElementById('username-input');
            const name = input.value.trim();
            if (name) {
                myNickname = name;
                // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –æ–±'—î–∫—Ç –∑ —ñ–º–µ–Ω–µ–º –Ü –∞–≤–∞—Ç–∞—Ä–∫–æ—é
                socket.emit('login', { name: name, avatar: myAvatar });
            }
        }

        socket.on('login success', () => {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app').style.display = 'flex';
        });

        // === 3. –°–ü–ò–°–û–ö –ö–û–†–ò–°–¢–£–í–ê–ß–Ü–í ===
        socket.on('update user list', (users) => {
            const list = document.getElementById('user-list');
            list.innerHTML = "";
            
            users.forEach(userObj => {
                // userObj —Ç–µ–ø–µ—Ä –≤–∏–≥–ª—è–¥–∞—î —Ç–∞–∫: { name: "Ivan", avatar: "..." }
                const name = userObj.name;
                const avatar = userObj.avatar;
                
                if (name === myNickname) return;

                // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –∞–≤–∞—Ç–∞—Ä–∫—É –≤ –ø–∞–º'—è—Ç—å
                userAvatars[name] = avatar;

                const li = document.createElement('li');
                
                let avatarHTML;
                if (avatar) {
                    avatarHTML = `<img src="${avatar}" class="avatar">`;
                } else {
                    const initial = name.charAt(0).toUpperCase();
                    avatarHTML = `<div class="default-avatar">${initial}</div>`;
                }

                li.innerHTML = `
                    ${avatarHTML}
                    <div class="user-info">
                        <div class="user-name">${name}</div>
                    </div>
                `;
                
                li.onclick = () => openChat(name, li);
                list.appendChild(li);
            });
        });

        // === 4. –í–Ü–î–ö–†–ò–¢–¢–Ø –ß–ê–¢–£ ===
        function openChat(user, element) {
            currentChatUser = user;
            
            document.getElementById('chat-title').innerText = user;
            
            // –°—Ç–∞–≤–∏–º–æ –∞–≤–∞—Ç–∞—Ä–∫—É –≤ —à–∞–ø–∫—É —á–∞—Ç—É
            const headerImg = document.getElementById('chat-header-img');
            if (userAvatars[user]) {
                headerImg.src = userAvatars[user];
                headerImg.style.display = 'block';
            } else {
                headerImg.style.display = 'none';
            }

            document.getElementById('messages').style.display = 'flex';
            document.getElementById('input-area').style.display = 'flex';

            if(element) {
                document.querySelectorAll('#user-list li').forEach(el => el.classList.remove('active'));
                element.classList.add('active');
            }

            document.getElementById('app').classList.add('chat-open');
            renderMessages();
        }

        function closeChat() {
            document.getElementById('app').classList.remove('chat-open');
            currentChatUser = null;
        }

        // === 5. –ß–ê–¢ ===
        function renderMessages() {
            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML = "";
            
            if (!chats[currentChatUser]) chats[currentChatUser] = [];

            chats[currentChatUser].forEach(msg => {
                const div = document.createElement('div');
                div.classList.add('message');
                div.classList.add(msg.from === '–Ø' ? 'my' : 'other');
                div.innerText = msg.content;
                messagesDiv.appendChild(div);
            });
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        document.getElementById('input-area').addEventListener('submit', (e) => {
            e.preventDefault();
            const input = document.getElementById('msg-input');
            const content = input.value;

            if (content && currentChatUser) {
                socket.emit('private message', { content, to: currentChatUser });

                if (!chats[currentChatUser]) chats[currentChatUser] = [];
                chats[currentChatUser].push({ from: '–Ø', content: content });

                renderMessages();
                input.value = '';
                input.focus();
            }
        });

        socket.on('private message', ({ content, from, avatar }) => {
            // –û–Ω–æ–≤–ª—é—î–º–æ –∞–≤–∞—Ç–∞—Ä, —è–∫—â–æ –≤—ñ–Ω —Ä–∞–ø—Ç–æ–º –∑–º—ñ–Ω–∏–≤—Å—è
            if (avatar) userAvatars[from] = avatar;

            if (!chats[from]) chats[from] = [];
            chats[from].push({ from: from, content: content });

            if (currentChatUser === from) {
                renderMessages();
            } else {
                if(navigator.vibrate) navigator.vibrate(200);
            }
        });
    </script>
</body>
</html>