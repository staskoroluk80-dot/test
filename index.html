<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ß–∞—Ç (–í–∏–¥–∞–ª–µ–Ω–Ω—è –∫–æ–Ω—Ç–∞–∫—Ç—ñ–≤)</title>
    <style>
        /* === –ë–ê–ó–ê === */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; /* –ü—Ä–∏–±–∏—Ä–∞—î —Å–∏–Ω—ñ–π –∫–≤–∞–¥—Ä–∞—Ç –ø—Ä–∏ –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—ñ –Ω–∞ Android */ }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: #2d2d2d; height: 100dvh; width: 100vw; overflow: hidden; display: flex; user-select: none; /* –©–æ–± —Ç–µ–∫—Å—Ç –Ω–µ –≤–∏–¥—ñ–ª—è–≤—Å—è –ø—Ä–∏ –¥–æ–≤–≥–æ–º—É –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—ñ */ }

        /* === –ï–ö–†–ê–ù –í–•–û–î–£ === */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #1c1c1c; display: flex; justify-content: center; align-items: center; z-index: 999; }
        .login-box { background: #2c2c2c; padding: 30px; border-radius: 15px; text-align: center; color: white; width: 90%; max-width: 320px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        .avatar-upload { width: 100px; height: 100px; background: #444; border-radius: 50%; margin: 0 auto 20px; position: relative; cursor: pointer; overflow: hidden; border: 2px dashed #666; display: flex; align-items: center; justify-content: center; transition: 0.3s; }
        .avatar-upload img { width: 100%; height: 100%; object-fit: cover; display: none; }
        .avatar-upload span { font-size: 30px; color: #aaa; }
        #file-input { display: none; }
        .login-box input[type="text"] { padding: 12px; border-radius: 8px; border: 1px solid #444; background: #222; color: white; width: 100%; margin-bottom: 15px; outline: none; text-align: center; }
        .login-box button { padding: 12px; background: #0088cc; color: white; border: none; border-radius: 8px; cursor: pointer; width: 100%; font-weight: bold; }

        /* === –ì–û–õ–û–í–ù–ò–ô –ï–ö–†–ê–ù === */
        #app { display: flex; width: 100%; height: 100%; display: none; }

        /* –°–ê–ô–î–ë–ê–† */
        #sidebar { width: 320px; background: #212121; border-right: 1px solid #0f0f0f; display: flex; flex-direction: column; flex-shrink: 0; }
        .sidebar-header { padding: 15px; color: white; font-weight: bold; background: #2c2c2c; height: 60px; display: flex; align-items: center; justify-content: space-between; }
        .reset-btn { font-size: 11px; background: #444; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; }
        
        #user-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex-grow: 1; }
        
        #user-list li { padding: 10px 15px; color: #fff; cursor: pointer; border-bottom: 1px solid #2a2a2a; display: flex; align-items: center; transition: 0.2s; position: relative; }
        #user-list li:hover { background: #2a2a2a; }
        #user-list li.active { background: #2b5278; }
        
        /* –ï—Ñ–µ–∫—Ç –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—è */
        #user-list li:active { background: #1f1f1f; transform: scale(0.98); }

        .avatar-wrapper { position: relative; margin-right: 15px; pointer-events: none; }
        .avatar { width: 50px; height: 50px; border-radius: 50%; background: #555; object-fit: cover; display: block; }
        .default-avatar { width: 50px; height: 50px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; font-size: 20px; }
        
        .status-dot { position: absolute; bottom: 2px; right: 2px; width: 12px; height: 12px; border-radius: 50%; border: 2px solid #212121; }
        .online .status-dot { background-color: #00e676; }
        .offline .status-dot { background-color: #757575; }
        .offline .avatar, .offline .default-avatar { opacity: 0.5; filter: grayscale(100%); }

        .user-info { display: flex; flex-direction: column; overflow: hidden; pointer-events: none; }
        .user-name { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .user-status-text { font-size: 12px; margin-top: 3px; }
        .online .user-status-text { color: #00e676; }
        .offline .user-status-text { color: #888; }

        /* –ß–ê–¢ */
        #chat-area { flex-grow: 1; background: #0e1621; display: flex; flex-direction: column; position: relative; min-width: 0; }
        #chat-header { padding: 0 15px; background: #212121; color: white; border-bottom: 1px solid #0f0f0f; font-weight: bold; height: 60px; display: flex; align-items: center; gap: 10px; }
        .chat-header-avatar { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; }
        #chat-status-sub { font-size: 12px; font-weight: normal; color: #888; margin-left: 10px; }

        #back-btn { display: none; background: none; border: none; color: white; font-size: 24px; cursor: pointer; }
        #messages { flex-grow: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; background-image: url('https://web.telegram.org/img/bg_0.png'); background-size: cover; }
        
        .message { max-width: 80%; padding: 8px 12px; border-radius: 12px; color: white; font-size: 15px; line-height: 1.4; position: relative; word-wrap: break-word; display: flex; flex-direction: column; }
        .message.my { background: #2b5278; align-self: flex-end; border-bottom-right-radius: 0; }
        .message.other { background: #182533; align-self: flex-start; border-bottom-left-radius: 0; }

        #input-area { padding: 10px; background: #212121; display: flex; gap: 10px; align-items: center; flex-shrink: 0; }
        #input-area input { flex-grow: 1; padding: 12px 20px; border-radius: 25px; border: none; background: #0e1621; color: white; font-size: 16px; outline: none; }
        #input-area button { background: #0088cc; color: white; border: none; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; display: flex; justify-content: center; align-items: center; font-size: 20px; flex-shrink: 0; }

        @media (max-width: 850px) {
            #sidebar { width: 100%; }
            #chat-area { width: 100%; }
            #app:not(.chat-open) #sidebar { display: flex; }
            #app:not(.chat-open) #chat-area { display: none; }
            #app.chat-open #sidebar { display: none; }
            #app.chat-open #chat-area { display: flex; }
            #back-btn { display: block; }
        }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <label for="file-input" class="avatar-upload" id="avatar-preview-container">
                <span>üì∑</span>
                <img id="avatar-preview" src="" alt="">
            </label>
            <input type="file" id="file-input" accept="image/*">
            <p style="color: #bbb; font-size: 13px; margin: 5px 0 15px;">–î–æ–¥–∞–π—Ç–µ —Ñ–æ—Ç–æ</p>
            <input type="text" id="username-input" placeholder="–í–∞—à–µ —ñ–º'—è..." autocomplete="off">
            <button onclick="login()">–£–≤—ñ–π—Ç–∏</button>
        </div>
    </div>

    <div id="app">
        <div id="sidebar">
            <div class="sidebar-header">
                –ö–æ–Ω—Ç–∞–∫—Ç–∏
                <button class="reset-btn" onclick="resetHiddenUsers()">–°–∫–∏–Ω—É—Ç–∏</button>
            </div>
            <ul id="user-list"></ul>
            <p style="text-align: center; color: #555; font-size: 12px; margin-top: 10px;">–ó–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç –¥–ª—è –≤–∏–¥–∞–ª–µ–Ω–Ω—è</p>
        </div>

        <div id="chat-area">
            <div id="chat-header">
                <button id="back-btn" onclick="closeChat()">‚¨Ö</button>
                <img id="chat-header-img" class="chat-header-avatar" style="display:none;">
                <div>
                    <span id="chat-title">–ß–∞—Ç</span>
                    <span id="chat-status-sub"></span>
                </div>
            </div>
            
            <div id="messages" style="display: none;"></div>

            <form id="input-area" style="display: none;">
                <input id="msg-input" autocomplete="off" placeholder="–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..." />
                <button type="submit">‚û§</button>
            </form>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
        // !!! –¢–í–û–Ñ –ü–û–°–ò–õ–ê–ù–ù–Ø REPLIT !!!
        const REPLIT_URL = "https://6a216fcf-12cf-4fac-8b1d-97739aabb946-00-33ambi0sfbjo6.spock.replit.dev";
        
        const socket = io(REPLIT_URL);
        
        let myNickname = "";
        let myAvatar = null;
        let currentChatUser = null;
        let userAvatars = {};
        let userStatuses = {};
        let chats = {};

        // === 1. –õ–û–ì–Ü–ö–ê –í–ò–î–ê–õ–ï–ù–ò–• –ö–û–†–ò–°–¢–£–í–ê–ß–Ü–í ===
        // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –∑ –ø–∞–º'—è—Ç—ñ –±—Ä–∞—É–∑–µ—Ä–∞ —Å–ø–∏—Å–æ–∫ —Ç–∏—Ö, –∫–æ–≥–æ –º–∏ –≤–∏–¥–∞–ª–∏–ª–∏
        let hiddenUsers = JSON.parse(localStorage.getItem('hiddenUsers')) || [];

        function hideUser(userName) {
            if (confirm(`–í–∏–¥–∞–ª–∏—Ç–∏ —á–∞—Ç –∑ ${userName} –∑—ñ —Å–ø–∏—Å–∫—É?`)) {
                hiddenUsers.push(userName);
                localStorage.setItem('hiddenUsers', JSON.stringify(hiddenUsers));
                // –ü—Ä–∏–º—É—Å–æ–≤–æ –æ–Ω–æ–≤–ª—é—î–º–æ —Å–ø–∏—Å–æ–∫
                requestUserListUpdate();
            }
        }

        function resetHiddenUsers() {
            if (confirm("–ü–æ–≤–µ—Ä–Ω—É—Ç–∏ –≤—Å—ñ—Ö –≤–∏–¥–∞–ª–µ–Ω–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤?")) {
                hiddenUsers = [];
                localStorage.setItem('hiddenUsers', JSON.stringify([]));
                requestUserListUpdate();
            }
        }

        // –¶—è —Ñ—É–Ω–∫—Ü—ñ—è –¥–æ–ø–æ–º–∞–≥–∞—î –Ω–∞–º –Ω–µ —á–µ–∫–∞—Ç–∏ —Å–∏–≥–Ω–∞–ª—É –≤—ñ–¥ —Å–µ—Ä–≤–µ—Ä–∞, –∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ –æ—Å—Ç–∞–Ω–Ω—ñ –¥–∞–Ω—ñ
        let lastUserList = [];
        function requestUserListUpdate() {
            renderUserList(lastUserList);
        }

        // === 2. –û–ë–†–û–ë–ö–ê –§–û–¢–û ===
        document.getElementById('file-input').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const maxSize = 150;
                    let width = img.width; let height = img.height;
                    if (width > height) { if (width > maxSize) { height *= maxSize / width; width = maxSize; } } 
                    else { if (height > maxSize) { width *= maxSize / height; height = maxSize; } }
                    canvas.width = width; canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    myAvatar = canvas.toDataURL('image/jpeg', 0.7);
                    const preview = document.getElementById('avatar-preview');
                    preview.src = myAvatar; preview.style.display = 'block';
                    document.querySelector('.avatar-upload span').style.display = 'none';
                }
                img.src = event.target.result;
            }
            reader.readAsDataURL(file);
        });

        function login() {
            const input = document.getElementById('username-input');
            const name = input.value.trim();
            if (name) {
                myNickname = name;
                socket.emit('login', { name: name, avatar: myAvatar });
            }
        }

        socket.on('login success', () => {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app').style.display = 'flex';
        });

        // === 3. –°–ü–ò–°–û–ö –ö–û–†–ò–°–¢–£–í–ê–ß–Ü–í ===
        socket.on('update user list', (users) => {
            lastUserList = users; // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∏–π —Å–ø–∏—Å–æ–∫ –≤—ñ–¥ —Å–µ—Ä–≤–µ—Ä–∞
            renderUserList(users);
        });

        function renderUserList(users) {
            const list = document.getElementById('user-list');
            list.innerHTML = "";
            
            // –°–æ—Ä—Ç—É—î–º–æ
            users.sort((a, b) => {
                if (a.status === 'online' && b.status === 'offline') return -1;
                if (a.status === 'offline' && b.status === 'online') return 1;
                return 0;
            });

            users.forEach(userObj => {
                const name = userObj.name;
                
                // !!! –§–Ü–õ–¨–¢–†–ê–¶–Ü–Ø: –Ø–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á —É —Å–ø–∏—Å–∫—É –≤–∏–¥–∞–ª–µ–Ω–∏—Ö - –ø—Ä–æ–ø—É—Å–∫–∞—î–º–æ –π–æ–≥–æ
                if (hiddenUsers.includes(name)) return;
                if (name === myNickname) return;

                const avatar = userObj.avatar;
                const status = userObj.status;
                
                userAvatars[name] = avatar;
                userStatuses[name] = status;

                const li = document.createElement('li');
                li.classList.add(status);

                let avatarHTML;
                if (avatar) {
                    avatarHTML = `<img src="${avatar}" class="avatar">`;
                } else {
                    const initial = name.charAt(0).toUpperCase();
                    avatarHTML = `<div class="default-avatar">${initial}</div>`;
                }

                const statusText = status === 'online' ? '–≤ –º–µ—Ä–µ–∂—ñ' : '–±—É–≤(–ª–∞) –Ω–µ—â–æ–¥–∞–≤–Ω–æ';

                li.innerHTML = `
                    <div class="avatar-wrapper">
                        ${avatarHTML}
                        <div class="status-dot"></div>
                    </div>
                    <div class="user-info">
                        <div class="user-name">${name}</div>
                        <div class="user-status-text">${statusText}</div>
                    </div>
                `;
                
                // –ó–í–ò–ß–ê–ô–ù–ò–ô –ö–õ–Ü–ö - –≤—ñ–¥–∫—Ä–∏—Ç–∏ —á–∞—Ç
                li.onclick = () => openChat(name, li, statusText);

                // === –î–û–î–ê–Ñ–ú–û "–î–û–í–ì–ï –ù–ê–¢–ò–°–ö–ê–ù–ù–Ø" ===
                addLongPressEvent(li, () => hideUser(name));

                list.appendChild(li);

                if(currentChatUser === name) {
                     document.getElementById('chat-status-sub').innerText = statusText;
                }
            });
        }

        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è –¥–æ–≤–≥–æ–≥–æ –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—è
        function addLongPressEvent(element, callback) {
            let timer;
            
            // –î–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω—ñ–≤ (Touch)
            element.addEventListener('touchstart', (e) => {
                timer = setTimeout(() => {
                    timer = null;
                    callback();
                }, 800); // 800 –º—ñ–ª—ñ—Å–µ–∫—É–Ω–¥ (–º–∞–π–∂–µ —Å–µ–∫—É–Ω–¥–∞)
            });

            element.addEventListener('touchend', () => {
                if (timer) clearTimeout(timer); // –Ø–∫—â–æ –≤—ñ–¥–ø—É—Å—Ç–∏–ª–∏ –ø–∞–ª–µ—Ü—å —Ä–∞–Ω—ñ—à–µ - —Å–∫–∞—Å–æ–≤—É—î–º–æ
            });

            element.addEventListener('touchmove', () => {
                if (timer) clearTimeout(timer); // –Ø–∫—â–æ –ø–æ—á–∞–ª–∏ –≥–æ—Ä—Ç–∞—Ç–∏ —Å–ø–∏—Å–æ–∫ - —Å–∫–∞—Å–æ–≤—É—î–º–æ
            });

            // –î–ª—è –∫–æ–º–ø'—é—Ç–µ—Ä—ñ–≤ (–ü—Ä–∞–≤–∏–π –∫–ª—ñ–∫ –º–∏—à—ñ)
            element.addEventListener('contextmenu', (e) => {
                e.preventDefault(); // –ó–∞–±–æ—Ä–æ–Ω—è—î–º–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–µ –º–µ–Ω—é –±—Ä–∞—É–∑–µ—Ä–∞
                callback();
            });
        }

        function openChat(user, element, statusText) {
            currentChatUser = user;
            
            document.getElementById('chat-title').innerText = user;
            const currentStatus = userStatuses[user] === 'online' ? '–≤ –º–µ—Ä–µ–∂—ñ' : '–±—É–≤(–ª–∞) –Ω–µ—â–æ–¥–∞–≤–Ω–æ';
            document.getElementById('chat-status-sub').innerText = currentStatus;

            const headerImg = document.getElementById('chat-header-img');
            if (userAvatars[user]) {
                headerImg.src = userAvatars[user];
                headerImg.style.display = 'block';
            } else {
                headerImg.style.display = 'none';
            }

            document.getElementById('messages').style.display = 'flex';
            document.getElementById('input-area').style.display = 'flex';

            if(element) {
                document.querySelectorAll('#user-list li').forEach(el => el.classList.remove('active'));
                element.classList.add('active');
            }

            document.getElementById('app').classList.add('chat-open');
            renderMessages();
        }

        function closeChat() {
            document.getElementById('app').classList.remove('chat-open');
            currentChatUser = null;
        }

        function renderMessages() {
            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML = "";
            if (!chats[currentChatUser]) chats[currentChatUser] = [];
            chats[currentChatUser].forEach(msg => {
                const div = document.createElement('div');
                div.classList.add('message');
                div.classList.add(msg.from === '–Ø' ? 'my' : 'other');
                div.innerText = msg.content;
                messagesDiv.appendChild(div);
            });
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        document.getElementById('input-area').addEventListener('submit', (e) => {
            e.preventDefault();
            const input = document.getElementById('msg-input');
            const content = input.value;
            if (content && currentChatUser) {
                socket.emit('private message', { content, to: currentChatUser });
                if (!chats[currentChatUser]) chats[currentChatUser] = [];
                chats[currentChatUser].push({ from: '–Ø', content: content });
                renderMessages();
                input.value = '';
                input.focus();
            }
        });

        socket.on('private message', ({ content, from, avatar }) => {
            if (avatar) userAvatars[from] = avatar;
            if (!chats[from]) chats[from] = [];
            chats[from].push({ from: from, content: content });
            if (currentChatUser === from) {
                renderMessages();
            } else {
                if(navigator.vibrate) navigator.vibrate(200);
            }
        });
    </script>
</body>
</html>